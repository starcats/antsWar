<!doctype html>

<html>
  <head>
    <meta charset='utf-8' />
    <title>antsWar</title>
  </head>
  <body>
  </body>
</html>


<script src='http://cdn.rawgit.com/phi-jp/phina.js/v0.2.0/build/phina.js'></script>
<script>
// グローバルに展開
phina.globalize();

var quest1Time = 1;//秒
var fps = 30;
var foodFlag = 0;
  //  foodFlag 説明
  //  0: 消える デフォルト
  //  1: 餌を探しに行くを押すと1になる
  //  2: クエストが終了すると2になり餌出現
  //  3: 3の時に回収するを押すとアリが回収しに行く
  //  4: 回収アクションが重複しないように

var ASSETS = {
  image: {
    bg: 'images/bg.png',
    menu: 'images/menu.png',
    ant: 'images/ant.png',
    test: 'images/test.png',
    food: 'images/sakuranbo.png',
    suana: 'images/suana.png',
  },
  // // スプライトシート
  // spritesheet: {
  //   "test_ss":
  //   {
  //     // フレーム情報
  //     "frame": {
  //       "width": 64, // 1フレームの画像サイズ（横）
  //       "height": 64, // 1フレームの画像サイズ（縦）
  //       "cols": 6, // フレーム数（横）
  //       "rows": 3, // フレーム数（縦）
  //     },
  //     // アニメーション情報
  //     "animations" : {
  //       "walk": { // アニメーション名
  //         "frames": [12,13,14], // フレーム番号範囲
  //         "next": "walk", // 次のアニメーション
  //         "frequency": 2, // アニメーション間隔
  //       },
  //     }
  //   },
  // }
};

// MainScene クラスを定義
phina.define('MainScene', {
  superClass: 'DisplayScene',
  init: function() {
    this.superInit();
    this.width = 640;
    // 背景色を指定
    this.backgroundColor = '#444';
    // 背景を生成
    this.bg = Sprite('bg',640,600).addChildTo(this).setOrigin(0,0);
    this.suana = Sprite('suana',100,100).addChildTo(this).setPosition(300,300);
    // メニューボタン生成
    this.menu = menuButton().addChildTo(this);
    // アリ生成
    this.ant = ant().addChildTo(this);
    
    // // テストスプライト画像作成
    // var sprite = Sprite('test', 64, 64).addChildTo(this);
    // // スプライトにフレームアニメーションをアタッチ
    // var anim = FrameAnimation('test_ss').attachTo(sprite);
    // // アニメーションを指定
    // anim.gotoAndPlay('walk');
    // // 初期位置
    // sprite.x = this.gridX.center();
    // sprite.y = this.gridY.center();
  },
  update: function() {
    if (foodFlag === 2) {
      FOOD().addChildTo(this);//餌を探しに行った時餌出現
    }
  }
});


 /*
 * メニューボタン
 */
phina.define('menuButton', {
  superClass: 'DisplayElement',

  init: function() {
    this.superInit();
    //メニュー背景
    Sprite('menu',640,360).addChildTo(this).setOrigin(0,0).setPosition(0,600);
    
    //餌を探しに行くボタン
    var feedButton = Button({
      text: '餌を探す',
      fill: 'rgb(100,100,100)',
      stroke: "white",
      width: 250,
      height: 70,
      fontSize: 25,
    }).addChildTo(this).setPosition(480,645);
    //ボタンを押した時クエストバー出現
    feedButton.on('click', function() {
      questBar(20,645).addChildTo(this);
      foodFlag = 1;
    }.bind(this));

    //餌を回収するボタン
    var antButton = Button({
      text: '餌を回収する',
      fill: 'rgb(100,100,100)',
      stroke: "white",
      width: 250,
      height: 70,
      fontSize: 25,
    }).addChildTo(this).setPosition(480,735);
    //ボタンを押した時クエストバー出現
    antButton.on('click', function() {
      questBar(20,735).addChildTo(this);
      if (foodFlag === 2) {
        foodFlag = 3;
      }
    }.bind(this));
  },
});

 /*
 * アリさん
 */
phina.define('ant', {
  superClass: 'DisplayElement',

  init: function() {
    this.superInit();
    // ランダムに歩く
    this.vx = Random.randint(-3, 3);
    this.vy = Random.randint(-3, 3);
    this.ant = Sprite('ant',60,60).addChildTo(this).setPosition(340,250);
    
  },

  update: function(app) {
    this.ant.x += this.vx;
    this.ant.y += this.vy;
    // 画面端との判定
    if (this.ant.left < 0 || 640 < this.ant.right) {
      // 速度を反転する
      this.vx *= -1;
    }
    if (this.ant.top < 0 || 600 < this.ant.bottom) {
      // 速度を反転する
      this.vy *= -1;
    }
    // 餌が出現してたら餌を回収しに行く
    if (foodFlag === 3) {
      foodFlag = 4;
      this.ant.tweener.moveTo(100,100,3000)
        .call(function() {
          //餌の回収完了
          foodFlag = 0;
          console.log('finish');
        })
        .moveTo(300,300,3000)
        .play();
    }
  },
});

 /*
 * えさ
 */
phina.define('FOOD', {
  superClass: 'DisplayElement',

  init: function() {
    this.superInit();
    this.food = Sprite('food').addChildTo(this).setPosition(100,100);
  },

  update: function(app) {
    if (foodFlag === 0) {
      this.food.remove();
    }
  },
});

 /*
 * クエスト進捗バー
 */
phina.define('questBar', {
  superClass: 'DisplayElement',
  init: function(x,y) {
    this.superInit();
    this.bar = Shape().addChildTo(this).setOrigin(0,0.5);
    this.bar.x = x;
    this.bar.y = y;
    this.bar.width = 0;
    this.bar.maxWidth = 300;
    this.bar.height = 40;
    this.count = 0

  },
  update: function(app) {
    this.bar.width += this.bar.maxWidth / fps / quest1Time;
    if (this.bar.width >= 300) {
      this.bar.width = 300;
      this.remove();
      if (foodFlag === 1) {
        foodFlag = 2;//餌を出現させる
      }
    }
  },
});


/*
 * メイン処理
 */
phina.main(function() {
  // アプリケーションを生成
  var app = GameApp({
    startLabel: 'main', // MainScene から開始
    assets: ASSETS,
  });
  app.fps = fps;
  // 実行
  app.run();
});

</script>